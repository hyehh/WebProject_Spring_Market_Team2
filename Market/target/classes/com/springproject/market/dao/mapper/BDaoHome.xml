<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.springproject.market.dao.BDaoHome">
	<select id="productView" resultType="com.springproject.market.dto.BDtoProduct">
		SELECT P.PCODE, P.PNAME, P.PCATEGORY, P.PPRICE, P.PPRICEDC, 100-P.PPRICEDC/PPRICE*100 AS PDISCOUNT, P.PEXPIRATIONDATE, P.PPRODUCTEA, SUM(B.BQUANTITY) AS PPRODUCTEA, P.PFILEPATH FROM PRODUCT AS P, BNS AS B WHERE P.PCODE=#{param1} AND P.PCODE=B.PRODUCT_PCODE AND P.PDELETEDATE IS NULL
	</select>
	
	<insert id="registerQ">
		INSERT INTO QNA(PRODUCT_PCODE, CUSTOMER_CID, QTITLE, QCONTENT, QADDDATE, SELLER_SID) VALUES(#{param1}, #{param2}, #{param3}, #{param4}, NOW(), 'admin')
	</insert>
	
	<select id="qnaList" resultType="com.springproject.market.dto.BDtoQnA">
		SELECT QNACODE, CUSTOMER_CID, QTITLE, QCONTENT, QADDDATE, ACONTENT, AADDDATE AS ANSWER, QFILEPATH FROM QNA WHERE PRODUCT_PCODE=#{param1} AND ADELETEDATE IS NULL AND QDELETEDATE IS NULL LIMIT #{param2}, #{param3}
	</select>
	
	<select id="qnaListCount" resultType="Integer">
		SELECT COUNT(QNACODE) FROM QNA WHERE PRODUCT_PCODE=#{param1} AND QDELETEDATE IS NULL
	</select>
	
	<select id="reviewList" resultType="com.springproject.market.dto.BDtoReview">
		SELECT BREVIEWCONTENT, BREVIEWSCORE, BREVIEWWRITEDATE, CUSTOMER_CID, RFILEPATH FROM BNS WHERE PRODUCT_PCODE=#{param1} AND BREVIEWDELETEDATE IS NULL AND BREVIEWWRITEDATE IS NOT NULL  LIMIT #{param2}, #{param3}
	</select>
	
	<select id="reivewListCount" resultType="Integer">
		SELECT COUNT(BREVIEWWRITEDATE) FROM BNS WHERE PRODUCT_PCODE=#{param1} AND BREVIEWDELETEDATE IS NULL
	</select>
	
	<select id="reviewStar" resultType="com.springproject.market.dto.BDtoReview">
		SELECT SUM(BREVIEWSCORE)/COUNT(BREVIEWSCORE) AS STAR, COUNT(BREVIEWSCORE) AS COUNT FROM BNS WHERE PRODUCT_PCODE=#{param1} AND BREVIEWDELETEDATE IS NULL
	</select>
	
	<select id="deadlineList" resultType="com.springproject.market.dto.BDtoProductList">
		SELECT P.PCODE, P.PNAME, P.PEXPIRATIONDATE, P.PPRICEDC, 100-P.PPRICEDC/P.PPRICE*100 AS PDISCOUNT, SUM(B.BREVIEWSCORE)/COUNT(B.BREVIEWSCORE) AS STAR, COUNT(B.BREVIEWWRITEDATE) AS PCOUNT, P.PFILEPATH FROM PRODUCT AS P, BNS AS B WHERE P.PCODE=B.PRODUCT_PCODE AND P.PDELETEDATE IS NULL AND B.BREVIEWDELETEDATE IS NULL AND P.PEXPIRATIONDATE BETWEEN NOW() AND DATE_ADD(NOW(),INTERVAL 1 WEEK ) GROUP BY P.PCODE ORDER BY P.PEXPIRATIONDATE
	</select>
	
	<select id="newList" resultType="com.springproject.market.dto.BDtoProductList">
		SELECT P.PCODE, P.PNAME, P.PEXPIRATIONDATE, P.PPRICEDC, 100-P.PPRICEDC/P.PPRICE*100 AS PDISCOUNT, SUM(B.BREVIEWSCORE)/COUNT(B.BREVIEWSCORE) AS STAR, COUNT(B.BREVIEWWRITEDATE) AS PCOUNT, PFILEPATH FROM PRODUCT AS P, BNS AS B WHERE P.PCODE=B.PRODUCT_PCODE AND P.PDELETEDATE IS NULL AND B.BREVIEWDELETEDATE IS NULL AND P.PADDDATE BETWEEN DATE_SUB(NOW(),INTERVAL 1 WEEK ) AND NOW() GROUP BY P.PCODE ORDER BY P.PADDDATE DESC
	</select>
	
	<select id="searchList" resultType="com.springproject.market.dto.BDtoProductList">
		SELECT P.PCODE, P.PNAME, P.PEXPIRATIONDATE, P.PPRICEDC, 100-P.PPRICEDC/P.PPRICE*100 AS PDISCOUNT, SUM(B.BREVIEWSCORE)/COUNT(B.BREVIEWSCORE) AS STAR, COUNT(B.BREVIEWWRITEDATE) AS PCOUNT, PFILEPATH FROM PRODUCT AS P, BNS AS B WHERE P.PCODE=B.PRODUCT_PCODE AND P.PDELETEDATE IS NULL AND B.BREVIEWDELETEDATE IS NULL AND P.PNAME LIKE CONCAT('%', #{param1}, '%') GROUP BY P.PCODE
	</select>

</mapper>